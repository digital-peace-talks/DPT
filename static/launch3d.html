<!DOCTYPE html>
<html>
	<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

	<title>Babylon.js sample code</title>

	<!-- Babylon.js -->
	<script src="https://code.jquery.com/pep/0.4.3/pep.js"></script>
	<!--
	<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
	<script src="https://preview.babylonjs.com/ammo.js"></script>
	<script src="https://preview.babylonjs.com/cannon.js"></script>
	<script src="https://preview.babylonjs.com/Oimo.js"></script>
	<script src="https://preview.babylonjs.com/gltf_validator.js"></script>
	<script src="https://preview.babylonjs.com/earcut.min.js"></script>
	<script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>
	<script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
	<script src="https://preview.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
	-->
	<script src="https://preview.babylonjs.com/babylon.js"></script>
	<!--
	<script src="https://preview.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
	<script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.min.js"/>
	<script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
	<script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
	-->

	<style>
		html, body {
			overflow: hidden;
			width: 100%;
			height: 100%;
			margin: 0;
			padding: 0;
		}

		#renderCanvas {
			width: 100%;
			height: 100%;
			touch-action: none;
		}
	</style>
	</head>
	<body>
	<canvas id="renderCanvas" ></canvas>
	<script>
		var canvas = document.getElementById("renderCanvas");
		
		function wrapText(context, text, x, y, maxWidth, lineHeight) {
			var words = text.split(' ');
			var line = '';
			for(var n = 0; n < words.length; n++) {
				var testLine = line + words[n] + ' ';
				var metrics = context.measureText(testLine);
				var testWidth = metrics.width;
				if (testWidth > maxWidth && n > 0) {
					context.fillText(line, x, y);
					line = words[n] + ' ';
					y += lineHeight;
				} else {
					line = testLine;
				}
			}
			context.fillText(line, x, y);
		}

		function textBlock(x, y, z, name, text) {
			//Set width an height for plane
			var planeWidth = 10;
			var planeHeight = 2.5; //10;

			//Create plane
			var plane = BABYLON.MeshBuilder.CreatePlane(name, {width:planeWidth, height:planeHeight}, scene);

			//Set width and height for dynamic texture using same multiplier
			var DTWidth = planeWidth * 120; //64;
			var DTHeight = planeHeight * 80; //64

			var dynamicTexture = new BABYLON.DynamicTexture("DynamicTexture", {width:DTWidth, height:DTHeight}, scene);

			//Check width of text for given font type at any size of font
			var ctx = dynamicTexture.getContext();

			dynamicTexture.hasAlpha = true;
			ctx.fillStyle = 'transparent';

			textureContext = dynamicTexture.getContext();
			textureContext.font = " 28px Courier bold";
			textureContext.save();
			textureContext.fillStyle = "white";

			//wrapText(textureContext, text, 112, 112, 480, 25);
			wrapText(textureContext, text, 20, 25, 1180, 25);
			textureContext.restore();
			
			/*
			textureContext.beginPath();
			textureContext.arc(320, 320, 320, 0, Math.PI * 2, false);
			textureContext.closePath();
			textureContext.strokeStyle = "white";
			textureContext.lineWidth = 5;
			textureContext.stroke();
			*/

			dynamicTexture.update();

			//create material
			var mat = new BABYLON.StandardMaterial("mat", scene);
			mat.diffuseTexture = dynamicTexture;
			mat.emissiveColor = new BABYLON.Color3(0, .8, 1);

			//apply material
			plane.material = mat;

			// set the position
			plane.position.x = x;
			plane.position.y = y;
			plane.position.z = z;
			plane.showBoundingBox = false;

			return(plane);
		}

		function getCollisionBox() {
			//Simple box
			var box = new BABYLON.MeshBuilder.CreateBox("crate", {
				width: 100, 
				height: 30,
				depth: 40,
				sideOrientation: 1
			}, scene);

			box.position = new BABYLON.Vector3(7.5, 2.5, -19.99);

			var dynamicTexture = new BABYLON.DynamicTexture("DynamicTexture", {width: 1, height: 1}, scene);
			var ctx = dynamicTexture.getContext();

			dynamicTexture.hasAlpha = true;
			ctx.fillStyle = 'transparent';

			//create material
			var mat = new BABYLON.StandardMaterial("mat", scene);
			mat.diffuseTexture = dynamicTexture;
			mat.emissiveColor = new BABYLON.Color3(0, .8, 1);

			//apply material
			box.material = mat;

			dynamicTexture.update();

			return(box);
		}

		function getCamera() {
			// camera
//			var camera = new BABYLON.FreeCamera("FreeCamera", new BABYLON.Vector3(0, 0, -10), scene);
			var camera = new BABYLON.FlyCamera("FlyCamera", new BABYLON.Vector3(0, 0, -10), scene);
//			var camera = new BABYLON.ArcRotateCamera("Camera", -Math.PI / 2, Math.PI / 2, 2, new BABYLON.Vector3(0, 0, -10), scene);			
/*
			camera.rollCorrect = 10;
			camera.bankedTurn = true;
			camera.bankedTurnLimit = Math.PI / 8;
			camera.bankedTurnMultiplier = 1;
*/

			camera.keysLeft.push(37);
			camera.keysUp.push(38);
			camera.keysRight.push(39);
			camera.keysDown.push(40);

			camera.keysForward.push(33);
			camera.keysBackward.push(34);

			camera.lowerRadiusLimit = 1;
			camera.upperRadiusLimit = 10;
/*
*/
			camera.acceleration = 0.01;
			camera.speed = 0.5;

			return(camera);
		}

		var createTopicScene = function() {
			var scene = new BABYLON.Scene(engine);

			// lights - no light!!
			// var light = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(0, 0, -1), scene);
			// light.intensity = 0.9;

			scene.clearColor = new BABYLON.Color3(10/255, 80/255, 119/255);

			camera = getCamera();
			camera.attachControl(canvas, true);

			box = getCollisionBox();

			// Enable Collisions
			box.checkCollisions = true;
			camera.checkCollisions = true;
			scene.collisionsEnabled = true;

			//When pointer down event is raised
			scene.onPointerDown = function (evt, pickResult) {
				// if the click hits the ground object, we change the impact position
				if(pickResult.hit) {
					const jsonFromName = JSON.parse(pickResult.pickedMesh.name);
					if(jsonFromName && jsonFromName.context == "topicMap") {
						console.log("hit topicId: "+jsonFromName.topicId);
						pickResult.pickedMesh.showBoundingBox = true;
						setTimeout(function() {
							pickResult.pickedMesh.showBoundingBox = false;
						}, 100);
					}
				}
			};

			return scene;
	}

	__createScene = createTopicScene;

	var engine = new BABYLON.Engine(canvas, true); //, { preserveDrawingBuffer: true, stencil: true });
	var scene = createTopicScene();

	document.addEventListener("DOMContentLoaded", function(event) {
		var socket = io.connect(
			window.location.protocol + "//" + window.location.host,
			{
				transports: ["websocket"],
			}
		);

		var dpt = new DPT(socket);
		var restObj = {};
		var whoami = {
			dptUUID: "",
			user: {},
		};

		// Handle the incomming websocket trafic
		socket.on("connect", () => {
			// if needed, we could keep socket.id somewhere
			if (document.cookie) {
				dpt.userLogin(document.cookie);
			}
		});

		socket.on("private", function(restObj) {
			if (restObj.method == "post") {
				if (restObj.path == "/user/login/") {
					whoami.dptUUID = restObj.data.dptUUID;
					if (restObj.data.message == "logged in") {
						whoami.user = restObj.data.user;
						dpt.getTopic();
					}
					if (restObj.data.message == "user unknown") {
						whoami.user = {};
					}
				}
			}
		});

		socket.on("error", function(e) {
			console.log("System", e ? e : "A unknown error occurred");
			document.location.reload(true);
			window.location.reload(true);
		});

		socket.on("api", function(restObj) {
			if(!restObj || !restObj.path || !restObj.method) {
				return;
			}
			if(restObj.path == '/topic/') {
				var options = '';

				var n = Math.floor((Math.sqrt(restObj.data.length)));
				var x = 0 - Math.floor(n/2)*10, xstart = x; xmax = (n-1)*10;
				var y = ymax = (n-1)*2.5; ystart = ymax; y = ystart;

				for (var i in restObj.data) {
					if(restObj.data[i].user == 'mine') {
						options = '<span class="editTopic" id="'
								+ restObj.data[i]._id
								+ '">&#128393;</span>';
					} else {
						options = '';
					}
					var plane = textBlock(
							x, y, 0,
							`{"context": "topicMap", "topicId": "${restObj.data[i]._id}"}`,
							`${restObj.data[i].content} [ ${restObj.data[i].opinions.length} ]`);
					x+=10;
					if(x > xmax) {
						y -= 2.5;
						x=xstart;
					}
/*
					jQuery('div.col.left').append(
						'<li> <a class="opinionlist" id="'
						+ restObj.data[i]._id
						+ '" href="#">'
						+ restObj.data[i].content
						+ "</a>"
						+ ' [' + restObj.data[i].opinions.length + '] '
						+ options+"</li><br>");
*/
				}
				//topicEdit();
				//topicForm();
			} 
		});

		engine.runRenderLoop(function () {
			if(scene) {
				scene.render();
			}
		});

		// Resize
		window.addEventListener("resize", function () {
			engine.resize();
		});

		/*
	for(i=-40; i <= 50; i+=10) {}
		for(j=-10; j <= 12.5; j+=2.5) {
//		for(j=-40; j <= 50; j+=10) {}
			plane = textBlock(i, j, 0, 'topicId'+i+j, 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam vol uptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum X');
		}
		*/
	});

	</script>
	</body>
	<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
<!-- <script src="https://code.jquery.com/jquery-1.11.1.js"></script> -->
	<script src="dpt-client.js"></script>
</html>
